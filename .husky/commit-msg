#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MSG_FILE=$1
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# 브랜치 이름에서 숫자 패턴의 이슈 번호를 추출합니다 (예: chore/9-husky-lint-staged -> 9)
# 여러 개가 발견되면 첫 번째 것을 사용합니다.
EXTRACTED_ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oP "/\K[0-9]+" | head -1)

if [ -n "$EXTRACTED_ISSUE_NUMBER" ]; then
  FORMATTED_ISSUE_ID="#$EXTRACTED_ISSUE_NUMBER"
  COMMIT_MESSAGE=$(cat "$COMMIT_MSG_FILE")
  # 커밋 메시지에 이미 이슈 ID가 포함되어 있는지 확인합니다 (대소문자 구분 안 함)
  if ! echo "$COMMIT_MESSAGE" | grep -iq "$FORMATTED_ISSUE_ID"; then
    echo "$COMMIT_MESSAGE ($FORMATTED_ISSUE_ID)" > "$COMMIT_MSG_FILE"
    echo "✅ 커밋 메시지에 이슈 ID '$FORMATTED_ISSUE_ID'가 추가되었습니다."
  else
    echo "ℹ️ 커밋 메시지에 이미 이슈 ID '$FORMATTED_ISSUE_ID'가 포함되어 있습니다. 변경 사항 없음."
  fi
else
  echo "⚠️ 브랜치 이름 '$BRANCH_NAME'에서 이슈 ID를 찾을 수 없습니다. 커밋 메시지는 변경되지 않습니다."
fi
